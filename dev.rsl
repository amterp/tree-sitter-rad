#!/usr/bin/env rad
---
Releases new version of the RSL tree sitter.

Releases new version of the RSL tree sitter.
Doc: https://tree-sitter.github.io/tree-sitter/creating-parsers/6-publishing.html
---
args:
    version v string = "" # Specify to release a new version.
    no_push "no-push" P bool # Enable to not push.

    version regex "^[0-9]+\.[0-9]+\.[0-9]+$"

if version:
    clean = unsafe $`git status --porcelain | grep -q .`
    print(clean)
    if not clean:
        print(red("Exiting!"))
        print("Your", yellow("git status"), "isn't clean, first commit/shelve/clean any files before releasing a new version.")
        exit(1)

$!`tss version {version}`

$!`git diff --compact-summary`

if not confirm("Continue? [y/n] > "):
    print(red("Resetting and exiting..."))
    $!`git reset --hard`
    exit(1)

$!`git add .`

msg = "Release version {version}"
$!`git commit -m "{msg}"`
$!`git tag -a v{version} -m "{msg}"`

push_cmd = `git push origin main --tags`

if no_push:
    print("Not pushing, remember to do it yourself with", yellow(push_cmd))
else:
    $!push_cmd

print(green("Done!"))

// relies on `tss` being the 0.25+ version of tree-sitter CLI.
// as of writing, has to be compiled locally from source.
